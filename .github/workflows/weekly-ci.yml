name: Scheduled CI

on:
  workflow_dispatch:
  schedule:
    - cron: 0 6 * * 0  # Sunday at 6 AM UTC

permissions:
  contents: read
  issues: write

env:
  # Many color libraries just need this variable to be set to any value.
  # Set it to 3 to support 8-bit color graphics (256 colors per channel)
  # for libraries that care about the value set.
  FORCE_COLOR: 3

jobs:
  # test: is removed, as I don't aim to keep this app working with newer packages.
  pip-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false
      - uses: astral-sh/setup-uv@v7
      - name: Export packages
        run: >-
          uv export
          --all-packages
          --all-extras
          --all-groups
          -o requirements.txt
          --no-emit-local
          --locked
      - uses: pypa/gh-action-pip-audit@v1.1.0
        with:
          inputs: requirements.txt
          require-hashes: true
      - name: Create failure issue
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            // Check for existing audit failure issues
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'scheduled-ci-audit',
              per_page: 10
            });

            if (existingIssues.data.length > 0) {
              // Update existing issue instead of creating new one
              const existingIssue = existingIssues.data[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `Another audit failure occurred on ${context.sha.substring(0, 7)}, see the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})`
              });
              await core.notice(`Updated existing issue ${existingIssue.html_url}`);

            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Scheduled CI Audit Failed - ${new Date().toISOString().split('T')[0]}`,
                body: `The scheduled CI audit check failed on ${context.sha.substring(0, 7)}.

            **Failed Jobs:**
            - Check the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})

            **Likely Causes:**
            - New security vulnerabilities detected by pip-audit

            **Next Steps:**
            - Review the logs above
            - Update locked dependencies
            - Re-run the workflow to verify fixes`,
                labels: ['scheduled-ci-audit'],
                assignees: [context.repo.owner],
              });
              await core.notice(`Created issue ${issue.data.html_url}`);
            }
